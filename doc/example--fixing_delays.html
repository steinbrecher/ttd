<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<style>
body {
  font-family: Helvetica, arial, sans-serif;
  font-size: 14px;
  line-height: 1.6;
  padding-top: 10px;
  padding-bottom: 10px;
  background-color: white;
  padding: 30px; }

body > *:first-child {
  margin-top: 0 !important; }
body > *:last-child {
  margin-bottom: 0 !important; }

a {
  color: #4183C4; }
a.absent {
  color: #cc0000; }
a.anchor {
  display: block;
  padding-left: 30px;
  margin-left: -30px;
  cursor: pointer;
  position: absolute;
  top: 0;
  left: 0;
  bottom: 0; }

h1, h2, h3, h4, h5, h6 {
  margin: 20px 0 10px;
  padding: 0;
  font-weight: bold;
  -webkit-font-smoothing: antialiased;
  cursor: text;
  position: relative; }

h1:hover a.anchor, h2:hover a.anchor, h3:hover a.anchor, h4:hover a.anchor, h5:hover a.anchor, h6:hover a.anchor {
  background: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA09pVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMy1jMDExIDY2LjE0NTY2MSwgMjAxMi8wMi8wNi0xNDo1NjoyNyAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNiAoMTMuMCAyMDEyMDMwNS5tLjQxNSAyMDEyLzAzLzA1OjIxOjAwOjAwKSAgKE1hY2ludG9zaCkiIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6OUM2NjlDQjI4ODBGMTFFMTg1ODlEODNERDJBRjUwQTQiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6OUM2NjlDQjM4ODBGMTFFMTg1ODlEODNERDJBRjUwQTQiPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDo5QzY2OUNCMDg4MEYxMUUxODU4OUQ4M0REMkFGNTBBNCIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDo5QzY2OUNCMTg4MEYxMUUxODU4OUQ4M0REMkFGNTBBNCIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/PsQhXeAAAABfSURBVHjaYvz//z8DJYCRUgMYQAbAMBQIAvEqkBQWXI6sHqwHiwG70TTBxGaiWwjCTGgOUgJiF1J8wMRAIUA34B4Q76HUBelAfJYSA0CuMIEaRP8wGIkGMA54bgQIMACAmkXJi0hKJQAAAABJRU5ErkJggg==) no-repeat 10px center;
  text-decoration: none; }

h1 tt, h1 code {
  font-size: inherit; }

h2 tt, h2 code {
  font-size: inherit; }

h3 tt, h3 code {
  font-size: inherit; }

h4 tt, h4 code {
  font-size: inherit; }

h5 tt, h5 code {
  font-size: inherit; }

h6 tt, h6 code {
  font-size: inherit; }

h1 {
  font-size: 28px;
  color: black; }

h2 {
  font-size: 24px;
  border-bottom: 1px solid #cccccc;
  color: black; }

h3 {
  font-size: 18px; }

h4 {
  font-size: 16px; }

h5 {
  font-size: 14px; }

h6 {
  color: #777777;
  font-size: 14px; }

p, blockquote, ul, ol, dl, li, table, pre {
  margin: 15px 0; }

hr {
  background: transparent url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAYAAAAECAYAAACtBE5DAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyJpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNSBNYWNpbnRvc2giIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6OENDRjNBN0E2NTZBMTFFMEI3QjRBODM4NzJDMjlGNDgiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6OENDRjNBN0I2NTZBMTFFMEI3QjRBODM4NzJDMjlGNDgiPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDo4Q0NGM0E3ODY1NkExMUUwQjdCNEE4Mzg3MkMyOUY0OCIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDo4Q0NGM0E3OTY1NkExMUUwQjdCNEE4Mzg3MkMyOUY0OCIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/PqqezsUAAAAfSURBVHjaYmRABcYwBiM2QSA4y4hNEKYDQxAEAAIMAHNGAzhkPOlYAAAAAElFTkSuQmCC) repeat-x 0 0;
  border: 0 none;
  color: #cccccc;
  height: 4px;
  padding: 0;
}

body > h2:first-child {
  margin-top: 0;
  padding-top: 0; }
body > h1:first-child {
  margin-top: 0;
  padding-top: 0; }
  body > h1:first-child + h2 {
    margin-top: 0;
    padding-top: 0; }
body > h3:first-child, body > h4:first-child, body > h5:first-child, body > h6:first-child {
  margin-top: 0;
  padding-top: 0; }

a:first-child h1, a:first-child h2, a:first-child h3, a:first-child h4, a:first-child h5, a:first-child h6 {
  margin-top: 0;
  padding-top: 0; }

h1 p, h2 p, h3 p, h4 p, h5 p, h6 p {
  margin-top: 0; }

li p.first {
  display: inline-block; }
li {
  margin: 0; }
ul, ol {
  padding-left: 30px; }

ul :first-child, ol :first-child {
  margin-top: 0; }

dl {
  padding: 0; }
  dl dt {
    font-size: 14px;
    font-weight: bold;
    font-style: italic;
    padding: 0;
    margin: 15px 0 5px; }
    dl dt:first-child {
      padding: 0; }
    dl dt > :first-child {
      margin-top: 0; }
    dl dt > :last-child {
      margin-bottom: 0; }
  dl dd {
    margin: 0 0 15px;
    padding: 0 15px; }
    dl dd > :first-child {
      margin-top: 0; }
    dl dd > :last-child {
      margin-bottom: 0; }

blockquote {
  border-left: 4px solid #dddddd;
  padding: 0 15px;
  color: #777777; }
  blockquote > :first-child {
    margin-top: 0; }
  blockquote > :last-child {
    margin-bottom: 0; }

table {
  padding: 0;border-collapse: collapse; }
  table tr {
    border-top: 1px solid #cccccc;
    background-color: white;
    margin: 0;
    padding: 0; }
    table tr:nth-child(2n) {
      background-color: #f8f8f8; }
    table tr th {
      font-weight: bold;
      border: 1px solid #cccccc;
      margin: 0;
      padding: 6px 13px; }
    table tr td {
      border: 1px solid #cccccc;
      margin: 0;
      padding: 6px 13px; }
    table tr th :first-child, table tr td :first-child {
      margin-top: 0; }
    table tr th :last-child, table tr td :last-child {
      margin-bottom: 0; }

img {
  max-width: 100%; }

span.frame {
  display: block;
  overflow: hidden; }
  span.frame > span {
    border: 1px solid #dddddd;
    display: block;
    float: left;
    overflow: hidden;
    margin: 13px 0 0;
    padding: 7px;
    width: auto; }
  span.frame span img {
    display: block;
    float: left; }
  span.frame span span {
    clear: both;
    color: #333333;
    display: block;
    padding: 5px 0 0; }
span.align-center {
  display: block;
  overflow: hidden;
  clear: both; }
  span.align-center > span {
    display: block;
    overflow: hidden;
    margin: 13px auto 0;
    text-align: center; }
  span.align-center span img {
    margin: 0 auto;
    text-align: center; }
span.align-right {
  display: block;
  overflow: hidden;
  clear: both; }
  span.align-right > span {
    display: block;
    overflow: hidden;
    margin: 13px 0 0;
    text-align: right; }
  span.align-right span img {
    margin: 0;
    text-align: right; }
span.float-left {
  display: block;
  margin-right: 13px;
  overflow: hidden;
  float: left; }
  span.float-left span {
    margin: 13px 0 0; }
span.float-right {
  display: block;
  margin-left: 13px;
  overflow: hidden;
  float: right; }
  span.float-right > span {
    display: block;
    overflow: hidden;
    margin: 13px auto 0;
    text-align: right; }

code, tt {
  margin: 0 2px;
  padding: 0 5px;
  white-space: nowrap;
  border: 1px solid #eaeaea;
  background-color: #f8f8f8;
  border-radius: 3px; }

pre code {
  margin: 0;
  padding: 0;
  white-space: pre;
  border: none;
  background: transparent; }

.highlight pre {
  background-color: #f8f8f8;
  border: 1px solid #cccccc;
  font-size: 13px;
  line-height: 19px;
  overflow: auto;
  padding: 6px 10px;
  border-radius: 3px; }

pre {
  background-color: #f8f8f8;
  border: 1px solid #cccccc;
  font-size: 13px;
  line-height: 19px;
  overflow: auto;
  padding: 6px 10px;
  border-radius: 3px; }
  pre code, pre tt {
    background-color: transparent;
    border: none; }

sup {
    font-size: 0.83em;
    vertical-align: super;
    line-height: 0;
}
* {
	-webkit-print-color-adjust: exact;
}
@media screen and (min-width: 914px) {
    body {
        width: 854px;
        margin:0 auto;
    }
}
@media print {
	table, pre {
		page-break-inside: avoid;
	}
	pre {
		word-wrap: break-word;
	}
}
</style>
<title>TTD Example: Fixing Delays</title>
<script type="text/x-mathjax-config">MathJax.Hub.Config({tex2jax:{inlineMath:[['$$$','$$$']]}});</script><script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
</head>
<body>
<h1>TTD Example: Fixing Delays</h1>

<p>Frequently, data is taken without pre-calibrating the PicoHarp or HydraHarp to
remove relative offsets between the channels. This example walks through how to
correct for these errors using the ttd collection of programs.</p>

<p>As an example, we'll use data from the SPDC source that was collected using the
NIST SNSPDs from the SPDC pair-source. This data is in .ht2 format, with the
following channel connections:</p>

<ul>
<li>Sync Channel: Alice, not dispersed</li>
<li>Channel 1: Bob, not dispersed</li>
<li>Channel 2: Alice, dispersed</li>
<li>Channel 3: Bob, dispersed</li>
<li>Channel 4: Not connected</li>
</ul>


<p>While we're using an .ht2 file for this example, the programs support all of
.pt2, .pt3, .ht2, and .ht3 for all file versions encountered so far.</p>

<h2>Step 1: Converting the file from a PicoQuant format to .ttd</h2>

<p>The various ttd programs are written to operate on a unified file format,
typically with the extension '.ttd'. In contrast to PicoQuant data files (e.g.
.ht2, .pt3), these files contain records only from a single channel, and photon
records are 64 bits long (as opposed to 32 bits/record in PicoQuant files. In
particular, .ttd files are binary files where each 64 bit block corresponds to
an unsigned 64 bit integer, which is the time tag in picoseconds of the photon
arrival.</p>

<p>This file format has several consequences. The main downside is that storage of
the TTD files requires approximately 2x as much disk space as for the PicoQuant
files. As it's advisable to hold on to the original PicoQuant files, use of this
format multiplies required storage by a factor a little less than 3. However,
disk space is cheap, and we gain several benefits:</p>

<ul>
<li><p>As $2^{64}$ picoseconds is approximately equal 213.5 days -- far longer than
any experiment needs to run -- we may store the timetags explicitly without
overflows. This allows us to process parts of a file without reading the entire
thing, or to split the files into pieces for separate processing as a function
of time.</p></li>
<li><p>We can perform operations on individual channels quickly and easily. This
example (fixing offsets between channels) is the most common use case.</p></li>
<li><p>Less obvious to the user, the coding and testing of the ttd programs is
greatly simplified by separating the conversion from PicoQuant data files to
.ttd and the post-processing. This reduces both bugs and development time,
meaning that new features can be implemented quickly and reliably.</p></li>
</ul>


<p>To convert the .ht2 file, we use the program pq-ttd. In this example, the data
file is named 'example-fixdelays.ht2'. pq-ttd has two command line options: '-i'
and '-o'. -i is required -- it provides pq-ttd with the PicoQuant data file,
while '-o' is optional and dicatates the output prefix. If this is omitted, the
output files simply use the original filename (without the extension).</p>

<p>Performing the actual conversion:</p>

<pre><code>% pq-ttd -i example-fixdelays.ht2 -o ex
Output Prefix: ex
Instrument: HydraHarp
Measurement Mode: T2
File Format Version: 2
Number of records: 71400917
Timing Resolution: 1 ps
Sync Period: 2178887 ps
Sync Rate: 458950 Hz

Records Read: 71400917
Elapsed Time: 1.37726 seconds
% ls -lh
-rw-r--r--  1 [user]  [group] 266M Jan  8 11:46 ex-channel-1.ttd
-rw-r--r--  1 [user]  [group]  73M Jan  8 11:46 ex-channel-2.ttd
-rw-r--r--  1 [user]  [group]  56M Jan  8 11:46 ex-channel-3.ttd
-rw-r--r--  1 [user]  [group]   0B Jan  8 11:46 ex-channel-4.ttd
-rw-r--r--  1 [user]  [group] 136M Jan  8 11:46 ex-channel-sync.ttd
-rwxr-xr-x  1 [user]  [group] 272M Jan  8 11:33 example-fixdelays.ht2
%
</code></pre>

<p>(Side note: Throughout this document, text cells like the one above, with a '%'
at the beginning of input lines, correspond to the shell/terminal)</p>

<p>Note that ex-channel-4.ttd is 0 bytes large, indicating that no records were
found on that channel (as expected). The rest of the files are what we'll use
for the following; to keep better track of them, let's rename them to something
more useful (and delete the extra file):</p>

<pre><code>% mv ex-channel-sync.ttd alice-nd.ttd
% mv ex-channel-1.ttd bob-nd.ttd
% mv ex-channel-2.ttd alice-d.ttd
% mv ex-channel-3.ttd bob-d.ttd
% rm ex-channel-4.ttd
% ls
alice-d.ttd     alice-nd.ttd        bob-d.ttd       bob-nd.ttd
example-fixdelays.ht2
%
</code></pre>

<h2>Step 2: Finding the time difference between channels</h2>

<p>In this case, we want to remove the delay between each pair (dispersed or not)
of channels, so that photons from the pair source arrive at the same "time" at
each detector. We can do this using the g2 calculation tool.</p>

<p>First, let's calculate the offset between the non-dispersed channels. As for all
ttd programs, the flag '--help' lets us check the command line options:</p>

<pre><code>% Usage: ttd-g2 [-1 input_file_1] [-2 input_file_2] [-o output_file_1]
              [-b bin_time] [-w window_time] [-T input2_offset]
    Notes:
        -b (--bin-time):     Specified in picoseconds
        -w (--window-time):  Window time in picoseconds
        -T (--input-offset): Offset input2 relative to input1 (input in picoseconds)
    Other options:
        -v (--verbose):      Enable verbose output to stdout
        -h (--help):         Print this help dialog
        -V (--version):      Print program version
%
</code></pre>

<p>The important pieces here are the bin time, the window time, and the various
files. We can ignore the option to offset one of the channels for now, though
we'll use it later for fine tuning. All times for ttd programs are given in
picoseconds (unless otherwise noted explicitly), and can either be given as an
integer (e.g. 50000 for 50ns) or in scientific notation (e.g. 5e4). Note that
only integers can be passed on the command line, so if you want 5.4e5, you'll
need to write 54e4.</p>

<p>Let's run the g2 with a window time of 100ns and a bin time of 10ps on the non-
dispersed data. Here, we've added the '-v' flag for verbose output, and add the
command 'time' at the beginning the line to monitor how long the command takes:</p>

<pre><code>% time ttd-g2 -v -b 1e3 -w 1e5 -1 alice-nd.ttd -2 bob-nd.ttd -o nd-g2.csv
Infile 1: alice-nd.ttd
Infile 2: bob-nd.ttd
Outfile: nd-g2.csv
Bin time: 10 ps
Window time: 100000 ps
Offset file 2 times by 0 ps
Block size: 16384 records

real    0m1.769s
user    0m1.587s
sys 0m0.103s
%
</code></pre>

<p>Block size is a debugging option which can be ignored (for the interested, it's
the number of records fetched from disk per 'fread' call). Otherwise, this
output lets us check that the program is doing what we expect, both with regards
to filenames and times.</p>

<p>Next, let's load and plot this histogram. The g2 csv file has two records per
line, corresponding to the center time of that bin and the number of counts in
that bin respectively.</p>

<pre><code>%pylab inline

g2_data = np.genfromtxt('nd-g2.csv', delimiter=',')
times = g2_data[:,0]
counts = g2_data[:,1]
plt.plot(times, counts)

Populating the interactive namespace from numpy and matplotlib





[&lt;matplotlib.lines.Line2D at 0x10a0eb790&gt;]
</code></pre>

<p><img src="fix_delays_13_2.png" alt="png" /></p>

<p>We can see that the autocorrelation is very sharply peaked at a time slightly
greater than zero. Extracting the time of this bin, and then plotting the 40
bins around it:</p>

<pre><code>peak_index = counts.argmax()
peak_time = times[peak_index]
print "Peak found at {0} ps".format(peak_time)
plt.plot(times[peak_index-20:peak_index+20], counts[peak_index-20:peak_index+20])

Peak found at 8710.0 ps





[&lt;matplotlib.lines.Line2D at 0x10a341990&gt;]
</code></pre>

<p><img src="fix_delays_15_2.png" alt="png" /></p>

<h2>Step 3: Shifting the ttd records</h2>

<p>The autocorrelation code computes time differences by subtracting the time of
the arrival in the '-2' file from the time of the arrival in the '-1' file. So
the above results mean that bob-nd.ttd is 8710 picoseconds after alice-nd.ttd.
We have the choice here of either shifting alice-nd.ttd forward by 8710ps or
shifting bob-nd.ttd back. Let's do the latter:</p>

<pre><code>% ttd-shift -i bob-nd.ttd -o bob-nd-shift.ttd -T -8710 -v
Input file: bob-nd.ttd
Output file: bob-nd-shift.ttd
Delay Time: -8710 ps
% 
</code></pre>

<p>Just to check that this worked, let's re-run the g2 using the delayed file. This
time, we can use a much smaller bin size (1ps, the minimum) and window size
(1000 ps) since we know -- assuming the above has worked correctly -- that the
peak will be centered at 0 time offset.</p>

<pre><code>% ttd-g2 -v -b 1 -w 1e3 -1 alice-nd.ttd -2 bob-nd-shift.ttd -o nd-g2-shift.csv
Infile 1: alice-nd.ttd
Infile 2: bob-nd-shift.ttd
Outfile: nd-g2-shift.csv
Bin time: 1 ps
Window time: 1000 ps
Offset file 2 times by 0 ps
Block size: 16384 records
% 


g2_data_shift = np.genfromtxt('nd-g2-shift.csv', delimiter=',')
times_shift = g2_data_shift[:,0]
counts_shift = g2_data_shift[:,1]
plt.plot(times_shift, counts_shift)




[&lt;matplotlib.lines.Line2D at 0x10a794c10&gt;]
</code></pre>

<p><img src="fix_delays_21_1.png" alt="png" /></p>

<p>And that's pretty much it! The same process can be repeated on the other pair of
channels (alice-d.ttd and bob-d.ttd) but since it's repetitive, I'll skip it
here.</p>
</body>
</html>
